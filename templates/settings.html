{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-white p-6 sm:p-12 md:p-16">
  <div class="max-w-4xl mx-auto">

    <!-- Header -->
    <h1 class="text-4xl font-extrabold mb-2 text-gray-900 text-center animate-fadeIn">Settings</h1>
    <p class="mb-10 text-center text-gray-600 text-lg animate-fadeIn delay-100">
      Personalize your currency converter experience and boost efficiency.
    </p>

    <!-- Settings Form -->
    <form class="grid gap-6" id="settings-form">

      <!-- Default Conversion Pair -->
      <div class="flex items-center gap-4 group animate-slideInLeft">
        <svg class="w-6 h-6 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 1v2m0 18v2m11-11h-2M3 12H1"/>
        </svg>
        <div class="flex-1 flex flex-col relative">
          <label class="mb-1 font-semibold text-gray-700">Default Conversion Pair</label>
          <div class="flex gap-2">
            <select id="default-from" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-400 w-full">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="JPY">JPY</option>
              <option value="CNY">CNY</option>
              <option value="GHS">GHS</option>
            </select>
            <select id="default-to" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-400 w-full">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="JPY">JPY</option>
              <option value="CNY">CNY</option>
              <option value="GHS">GHS</option>
            </select>
          </div>
        </div>
      </div>
      <hr class="border-gray-200">

      <!-- Conversion Precision -->
      <div class="flex items-center gap-4 group animate-slideInRight delay-100">
        <svg class="w-6 h-6 text-purple-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v8m-4-4h8"/>
        </svg>
        <div class="flex-1 flex flex-col">
          <label class="mb-1 font-semibold text-gray-700">Conversion Precision (Decimals)</label>
          <select id="precision-select" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-400 w-full">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
      </div>
      <hr class="border-gray-200">

      <!-- Auto-Update Rate -->
      <div class="flex items-center gap-4 group animate-slideInLeft delay-200">
        <svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M20 20v-6h-6"/>
        </svg>
        <div class="flex-1 flex flex-col">
          <label class="mb-1 font-semibold text-gray-700">Auto-Update Rate</label>
          <select id="update-rate" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-green-400 w-full">
            <option value="15">Every 15 mins</option>
            <option value="30">Every 30 mins</option>
            <option value="60">Every 1 hour</option>
          </select>
        </div>
      </div>
      <hr class="border-gray-200">

      <!-- Theme & Appearance -->
      <div class="flex items-center gap-4 group animate-slideInRight delay-300">
        <svg class="w-6 h-6 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m8.66-10h-1M3.34 12h-1"/>
        </svg>
        <div class="flex-1 flex flex-col relative">
          <label class="mb-1 font-semibold text-gray-700">Theme</label>
          <select id="theme-select" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-yellow-400 w-full">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
          <!-- Coming Soon overlay -->
          <div class="absolute inset-0 bg-white/30 backdrop-blur-md rounded-xl flex items-center justify-center">
            <span class="text-gray-800 font-bold text-lg">Coming Soon</span>
          </div>
        </div>
      </div>
      <hr class="border-gray-200">

      <!-- Notifications -->
      <div class="flex items-center gap-4 group animate-slideInLeft delay-400">
        <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405M19 13v-2a7 7 0 10-14 0v2l-2 2v1h18v-1l-2-2z"/>
        </svg>
        <div class="flex-1 flex flex-col">
          <label class="mb-1 font-semibold text-gray-700">Notifications</label>
          <select id="notification-select" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-red-400 w-full">
            <option value="all">All Updates</option>
            <option value="major">Only Major Changes</option>
            <option value="none">None</option>
          </select>
        </div>
      </div>
      <hr class="border-gray-200">

      <!-- Offline Mode Toggle -->
      <div class="flex items-center justify-between group animate-slideInRight delay-500">
        <span class="flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v-4a8 8 0 1116 0v4"/>
          </svg>
          <label class="font-semibold text-gray-700">Offline Mode</label>
        </span>
        <input type="checkbox" id="offline-mode" class="w-10 h-6 rounded-full bg-gray-300 accent-blue-500 transition duration-300">
      </div>
      <hr class="border-gray-200">

      <!-- Save Button -->
      <button type="submit" class="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold rounded-2xl shadow-lg transition-transform duration-300 hover:scale-105 mt-4 animate-bounce">
        Save Premium Settings
      </button>
    </form>
  </div>
</div>

<!-- Animations -->
<style>
@keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
.animate-fadeIn { animation: fadeIn 0.8s ease forwards; }
@keyframes slideInLeft { from { opacity:0; transform:translateX(-20px);} to {opacity:1; transform:translateX(0);} }
.animate-slideInLeft { animation: slideInLeft 0.8s ease forwards; }
@keyframes slideInRight { from { opacity:0; transform:translateX(20px);} to {opacity:1; transform:translateX(0);} }
.animate-slideInRight { animation: slideInRight 0.8s ease forwards; }
.delay-100 { animation-delay:0.1s; }
.delay-200 { animation-delay:0.2s; }
.delay-300 { animation-delay:0.3s; }
.delay-400 { animation-delay:0.4s; }
.delay-500 { animation-delay:0.5s; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const themeSelect = document.getElementById('theme-select');
  const defaultFrom = document.getElementById('default-from');
  const defaultTo = document.getElementById('default-to');
  const precisionSelect = document.getElementById('precision-select');
  const updateRate = document.getElementById('update-rate');
  const notificationSelect = document.getElementById('notification-select');
  const offlineMode = document.getElementById('offline-mode');
  const form = document.getElementById('settings-form');

  // Load saved settings
  if(localStorage.getItem('theme')) themeSelect.value = localStorage.getItem('theme');
  if(localStorage.getItem('defaultFrom')) defaultFrom.value = localStorage.getItem('defaultFrom');
  if(localStorage.getItem('defaultTo')) defaultTo.value = localStorage.getItem('defaultTo');
  if(localStorage.getItem('precision')) precisionSelect.value = localStorage.getItem('precision');
  if(localStorage.getItem('updateRate')) updateRate.value = localStorage.getItem('updateRate');
  if(localStorage.getItem('notifications')) notificationSelect.value = localStorage.getItem('notifications');
  if(localStorage.getItem('offlineMode') === 'true') offlineMode.checked = true;

  // Apply theme immediately
  applyTheme(themeSelect.value);
  themeSelect.addEventListener('change', () => applyTheme(themeSelect.value));

  function applyTheme(theme) {
    if(theme === 'dark'){
      document.documentElement.classList.add('dark');
      document.body.classList.add('bg-gray-900','text-white');
    } else {
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('bg-gray-900','text-white');
    }
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    localStorage.setItem('theme', themeSelect.value);
    localStorage.setItem('defaultFrom', defaultFrom.value);
    localStorage.setItem('defaultTo', defaultTo.value);
    localStorage.setItem('precision', precisionSelect.value);
    localStorage.setItem('updateRate', updateRate.value);
    localStorage.setItem('notifications', notificationSelect.value);
    localStorage.setItem('offlineMode', offlineMode.checked);
    alert('Settings saved successfully!');
  });

  // ---------------- NOTIFICATION + OFFLINE SUPPORT ----------------
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => console.log("SW registered"));
  }

  Notification.requestPermission();

  function showAndSaveNotification(title, body) {
    if (Notification.permission === "granted") {
      new Notification(title, { body });
    }
    localStorage.setItem("lastNotification", JSON.stringify({ title, body, time: Date.now() }));
  }

  if (!!window.EventSource) {
    const source = new EventSource("/stream");
    source.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const title = data.type === "rate" ? "Currency Update" : "Finance News";
      showAndSaveNotification(title, data.message);
    };
  }

  window.addEventListener("load", () => {
    const saved = localStorage.getItem("lastNotification");
    if (saved) {
      const { title, body } = JSON.parse(saved);
      showAndSaveNotification(title + " (last update)", body);
    }
  });

  window.addEventListener("online", () => {
    const saved = localStorage.getItem("lastNotification");
    if (saved) {
      const { title, body } = JSON.parse(saved);
      showAndSaveNotification(title + " (while offline)", body);
    }
  });
});
</script>
{% endblock %}
