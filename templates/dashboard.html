{% extends "base.html" %}
{% block content %}
<div class="space-y-8 p-6">

  <!-- Quick Converter -->
  <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-6 shadow-xl border border-white/30">
    <h2 class="text-3xl font-bold mb-6 text-gray-900">Quick Converter</h2>
    <form id="quick-converter" class="flex flex-wrap gap-4 items-center">
      <input type="number" step="0.01" name="amount" placeholder="Amount" required
             class="p-3 rounded-xl bg-white/30 text-gray-900 placeholder-gray-700 w-32 focus:outline-none focus:ring-2 focus:ring-blue-400">
      <select name="from_currency" class="p-3 rounded-xl bg-white/30 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400">
        {% for code, name in currencies.items() %}
          <option value="{{ code }}">{{ code }} - {{ name }}</option>
        {% endfor %}
      </select>
      <span class="text-gray-900 font-bold text-xl">→</span>
      <select name="to_currency" class="p-3 rounded-xl bg-white/30 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400">
        {% for code, name in currencies.items() %}
          <option value="{{ code }}">{{ code }} - {{ name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-xl text-white font-semibold transition duration-300">Convert</button>
    </form>
    <p id="conversion-result" class="mt-4 font-bold text-gray-900 text-lg"></p>
  </div>

  <!-- Top Rates with Heading -->
  <div>
    <h2 class="text-3xl font-bold mb-4 text-gray-900">Live Currency Rates</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
      {% for code, rate in rates.items() %}
        <div id="card-{{ code }}" class="rate-card bg-white/20 backdrop-blur-lg rounded-2xl p-6 text-center shadow-xl border border-white/30 transition duration-300">
          <h3 class="text-xl font-semibold text-gray-900 mb-2">USD → {{ code }}</h3>
          <p id="rate-{{ code }}" class="text-2xl font-bold text-gray-900">{{ rate }}</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Finance News Feed -->
  <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-6 shadow-xl border border-white/30">
    <h2 class="text-3xl font-bold mb-4 text-gray-900">Finance News</h2>
    <ul id="finance-news" class="space-y-3 max-h-[400px] overflow-y-auto"></ul>
  </div>

  <!-- USD → GHS 7-Day Trend Chart -->
  <div class="bg-white/20 backdrop-blur-lg rounded-2xl p-6 shadow-xl border border-white/30 relative">
    <h2 class="text-3xl font-bold mb-4 text-gray-900">USD → GHS (7-Day Trend)</h2>
    <div class="relative">
      <canvas id="usdGhsChart" class="rounded-xl"></canvas>
      <div class="absolute inset-0 bg-black/30 flex items-center justify-center rounded-xl">
        <span class="text-white text-2xl font-bold">Coming Soon</span>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ---------------- Quick Converter ----------------
  document.getElementById("quick-converter").addEventListener("submit", async function(e) {
    e.preventDefault();
    const f = new FormData(this);
    const payload = {
      amount: f.get("amount"),
      from_currency: f.get("from_currency"),
      to_currency: f.get("to_currency")
    };
    const res = await fetch("{{ url_for('api_convert') }}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById("conversion-result").textContent =
      `${payload.amount} ${payload.from_currency} = ${data.result} ${payload.to_currency}`;
  });

  // ---------------- Auto-refresh Top Rates ----------------
  async function refreshRates() {
    const res = await fetch("{{ url_for('api_live_rates') }}");
    const data = await res.json();
    for (const [code, newRate] of Object.entries(data)) {
      const el = document.getElementById(`rate-${code}`);
      const card = document.getElementById(`card-${code}`);
      if (el && card) {
        const oldRate = parseFloat(el.textContent);
        el.textContent = newRate;

        if (!isNaN(oldRate)) {
          if (newRate > oldRate) {
            el.classList.add("glow-green");
            card.classList.add("pulse-green");
            setTimeout(() => {
              el.classList.remove("glow-green");
              card.classList.remove("pulse-green");
            }, 1500);
          } else if (newRate < oldRate) {
            el.classList.add("glow-red");
            card.classList.add("pulse-red");
            setTimeout(() => {
              el.classList.remove("glow-red");
              card.classList.remove("pulse-red");
            }, 1500);
          }
        }
      }
    }
  }
  setInterval(refreshRates, 60000);

  // ---------------- Fetch Finance News ----------------
  async function fetchFinanceNews() {
    try {
      const res = await fetch("{{ url_for('api_finance_news') }}");
      const news = await res.json();
      const container = document.getElementById("finance-news");
      container.innerHTML = "";
      news.forEach(article => {
        const li = document.createElement("li");
        li.className = "p-3 bg-white/30 rounded-xl hover:bg-white/40 transition cursor-pointer";
        li.innerHTML = `<a href="${article.url}" target="_blank" class="text-gray-900 font-semibold">${article.title}</a><br>
                        <span class="text-gray-700 text-sm">${article.source}</span>`;
        container.appendChild(li);
      });
    } catch (err) {
      console.error("Error fetching news:", err);
    }
  }
  fetchFinanceNews();
  setInterval(fetchFinanceNews, 300000);

  // ---------------- USD → GHS 7-Day Trend Chart ----------------
  async function renderUsdGhsChart() {
    try {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(endDate.getDate() - 6);
      const formatDate = (d) => d.toISOString().split('T')[0];

      const response = await fetch(
        `https://api.currencyfreaks.com/v2.0/rates/timeseries?apikey=a4fb820d819142e389b430bddbc3cd89&base=USD&symbols=GHS&start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`
      );
      const data = await response.json();
      const rates = data.rates;
      const labels = [];
      const values = [];
      let lastKnown = null;

      for(let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        labels.push(dateStr);
        if(rates[dateStr] && rates[dateStr]["GHS"]) {
          values.push(parseFloat(rates[dateStr]["GHS"]));
          lastKnown = parseFloat(rates[dateStr]["GHS"]);
        } else {
          values.push(lastKnown || 0);
        }
      }

      const ctx = document.getElementById("usdGhsChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "USD/GHS",
            data: values,
            borderColor: "rgba(75,192,192,1)",
            backgroundColor: "rgba(75,192,192,0.2)",
            fill: true,
            tension: 0.3,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: 'black' } },
            y: { ticks: { color: 'black' }, beginAtZero: false }
          }
        }
      });

    } catch (err) {
      console.error("Error rendering USD/GHS chart:", err);
    }
  }
  renderUsdGhsChart();
</script>

<!-- Tailwind custom animations -->
<style>
  /* Number glow */
  @keyframes glowUp {
    0% { text-shadow: 0 0 5px #22c55e, 0 0 10px #22c55e; color: #22c55e; }
    100% { text-shadow: none; color: #111827; }
  }
  @keyframes glowDown {
    0% { text-shadow: 0 0 5px #ef4444, 0 0 10px #ef4444; color: #ef4444; }
    100% { text-shadow: none; color: #111827; }
  }
  .glow-green { animation: glowUp 1.5s ease-in-out; }
  .glow-red { animation: glowDown 1.5s ease-in-out; }

  /* Card pulse */
  @keyframes pulseGreen {
    0% { box-shadow: 0 0 10px #22c55e; }
    100% { box-shadow: none; }
  }
  @keyframes pulseRed {
    0% { box-shadow: 0 0 10px #ef4444; }
    100% { box-shadow: none; }
  }
  .pulse-green { animation: pulseGreen 1.5s ease-in-out; }
  .pulse-red { animation: pulseRed 1.5s ease-in-out; }
</style>
{% endblock %}
